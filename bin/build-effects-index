#!/bin/bash

echo "generating effects index"

script_folder=$(dirname "$(realpath "$0")")
target_folder=$(realpath "${script_folder}/../src/effects")
index_ts="${target_folder}/index.ts"
const_ts=$(realpath "${script_folder}/../src/consts/effect-types.json")

# Initialise le fichier index.json avec un objet JSON vide
echo "// File generated by $(basename $0)" > "$index_ts"
echo "" >> "$index_ts"
echo "import { BaseEffectSchema } from '../schemas/BaseEffect';" >> "$index_ts"
echo "" >> "$index_ts"

# Vérifie si jq est installé
if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed."
    exit 1
fi

echo "import z from 'zod';" >> "$index_ts"
echo '{' > "$const_ts"
b_first=1
for this_file in "$target_folder"/*.ts; do
    # Ignore index.ts
    this_basefile="$(basename $this_file)"
    this_basefile_nots="$(basename $this_file .ts)"
    effect_const="EFFECT_$(echo $this_basefile_nots | tr '[:lower:]' '[:upper:]' | tr '-' '_')"
    if [ "$this_basefile" != "index.ts" ]; then
        # Merge file content in index.json
        effect_name="$(grep -oP 'export const \K\S+' $this_file)"
        echo "import { $effect_name } from './$this_basefile_nots';" >> "$index_ts"
        if [ $b_first = "0" ]
        then
            echo "," >> "$const_ts"
        fi
        echo -n '    "'$effect_const'": "'$effect_const'"' >> "$const_ts"
        b_first=0
    fi
done
echo "" >> "$const_ts"
echo "}" >> "$const_ts"

echo "" >> "$index_ts"
echo "export const EffectDefinitionSchema = z.discriminatedUnion('type', [" >> "$index_ts"
# Iterate each .ts file
for this_file in "$target_folder"/*.ts; do
    # Ignore index.ts
    if [ "$(basename "$this_file")" != "index.ts" ]; then
        # Merge file content in index.json
        effect_name="$(grep -oP 'export const \K\S+' $this_file)"
        echo "    $effect_name," >> "$index_ts"
    fi
done
echo "]);" >> "$index_ts"
echo "" >> "$index_ts"

echo "" >> "$index_ts"
echo "export const EffectSchema = EffectDefinitionSchema.and(BaseEffectSchema);" >> "$index_ts"
echo "" >> "$index_ts"

echo "export type EffectDefinition = z.infer<typeof EffectSchema>;" >> "$index_ts"
echo "export type Effect = z.infer<typeof EffectSchema>;" >> "$index_ts"

echo "generated: $index_ts"
