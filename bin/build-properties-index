#!/bin/bash

echo "generating properties index"

script_folder=$(dirname "$(realpath "$0")")
target_folder=$(realpath "${script_folder}/../src/properties")
index_ts="${target_folder}/index.ts"
const_ts=$(realpath "${script_folder}/../src/consts/property-types.json")

# Initialise le fichier index.json avec un objet JSON vide
echo "// File generated by $(basename $0)" > "$index_ts"

# Vérifie si jq est installé
if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed."
    exit 1
fi

echo "import z from 'zod';" >> "$index_ts"

echo '{' > "$const_ts"
b_first=1
for this_file in "$target_folder"/*.ts; do
    # Ignore index.ts
    this_basefile="$(basename $this_file)"
    this_basefile_nots="$(basename $this_file .ts)"
    property_const="PROPERTY_$(echo $this_basefile_nots | tr '[:lower:]' '[:upper:]' | tr '-' '_')"
    if [ "$this_basefile" != "index.ts" ]; then
        # Merge file content in index.json
        property_name="$(grep -oP 'export const \K\S+' $this_file)"
        echo "import { $property_name } from './$this_basefile_nots';" >> "$index_ts"
        if [ $b_first = "0" ]
        then
            echo "," >> "$const_ts"
        fi
        echo -n '    "'$property_const'": "'$property_const'"' >> "$const_ts"
        b_first=0
    fi
done
echo "" >> "$const_ts"
echo "}" >> "$const_ts"

echo "" >> "$index_ts"
echo "export const PropertySchema = z.discriminatedUnion('type', [" >> "$index_ts"
# Iterate each .ts file
for this_file in "$target_folder"/*.ts; do
    # Ignore index.ts
    if [ "$(basename "$this_file")" != "index.ts" ]; then
        # Merge file content in index.json
        property_name="$(grep -oP 'export const \K\S+' $this_file)"
        echo "    $property_name," >> "$index_ts"
    fi
done
echo "]);" >> "$index_ts"
echo "" >> "$index_ts"
echo "export type Property = z.infer<typeof PropertySchema>;" >> "$index_ts"
echo "generated: $index_ts"
