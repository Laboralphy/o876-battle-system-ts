#!/bin/bash

echo "build property index"

script_folder=$(dirname "$(realpath "$0")")
target_folder="${script_folder}/../src/properties"
index_ts="${target_folder}/index.ts"

# Initialise le fichier index.json avec un objet JSON vide
echo "// File generated by $0" > "$index_ts"

# Vérifie si jq est installé
if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed."
    exit 1
fi

echo "import z from 'zod';" >> "$index_ts"
for this_file in "$target_folder"/*.ts; do
    # Ignore index.ts
    this_basefile="$(basename $this_file)"
    this_basefile_nots="$(basename $this_file .ts)"
    if [ "$this_basefile" != "index.ts" ]; then
        # Merge file content in index.json
        property_name="$(grep -oP 'export const \K\S+' $this_file)"
        echo "import { $property_name } from './$this_basefile_nots';" >> "$index_ts"
    fi
done

echo "" >> "$index_ts"
echo "export const PropertySchema = z.discriminatedUnion('type', [" >> "$index_ts"
# Iterate each .ts file
for this_file in "$target_folder"/*.ts; do
    # Ignore index.ts
    if [ "$(basename "$this_file")" != "index.ts" ]; then
        # Merge file content in index.json
        property_name="$(grep -oP 'export const \K\S+' $this_file)"
        echo "    $property_name," >> "$index_ts"
    fi
done
echo "]);" >> "$index_ts"
echo "" >> "$index_ts"
echo "export type Property = z.infer<typeof PropertySchema>;" >> "$index_ts"
